<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <title>ZarzƒÖdzanie Zam√≥wieniami</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="/images/logo.png" />
    <style>
        .dashboard-container {
            max-width: 1400px;
            margin: 100px auto 0;
            padding: 0 20px 40px;
            width: 100%;
            display: block;
        }

        .order-items-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 13px;
        }

        .order-items-list li {
            margin-bottom: 4px;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .order-items-list li:last-child {
            border-bottom: none;
        }
    </style>
</head>

<body>
    <header class="topbar">
        <div class="topbar-content">
            <div class="logo-section">
                <img src="/images/logo.png" class="topbar-logo" />
                <span class="site-title">Football Profiles</span>
            </div>
            <nav class="topbar-nav">
                <a href="dashboard.html" class="nav-tab">Panel</a>
                <a href="gallery.html" class="nav-tab">Galeria</a>
                <a href="forum.html" class="nav-tab">Forum</a>

                <a href="moderator-posts.html" class="nav-tab" id="moderatorLink" style="display:none;">Moderacja</a>
                <a href="admin-categories.html" class="nav-tab" id="adminLink" style="display:none;">Admin</a>
                <a href="admin-gallery-manage.html" class="nav-tab" id="galleryManageLink"
                    style="display:none;">ZarzƒÖdzaj Galeriami</a>
                <a href="admin-orders.html" class="nav-tab active" id="ordersLink" style="display:none;">Zam√≥wienia</a>
            </nav>
            <div class="topbar-actions">
                <div style="position:relative;">
                    <button id="notificationsBtn" class="icon-button" aria-label="Powiadomienia" style="display:none;">
                        <span>üîî</span>
                        <span id="notificationBadge" class="notification-badge" style="display:none;">0</span>
                    </button>
                    <div id="notificationsDropdown" class="notification-dropdown" style="display:none;">
                        <div class="notification-header">
                            <h3>Powiadomienia</h3>
                            <button id="markAllReadBtn" class="btn-link">Oznacz wszystkie jako przeczytane</button>
                        </div>
                        <div class="notification-list" id="notificationsList">
                            <div class="notification-empty">Brak powiadomie≈Ñ.</div>
                        </div>
                    </div>
                </div>

                <div id="authBar" class="authbar">
                    <span id="who">...</span>
                    <button id="logoutBtn" class="btn btn-ghost">Wyloguj</button>
                </div>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <div class="page-header">
            <h1 class="page-title">üì¶ ZarzƒÖdzanie Zam√≥wieniami</h1>
        </div>

        <div class="admin-panel">
            <div id="ordersList">≈Åadowanie...</div>
        </div>
    </div>

    <script type="module">
        import { fetchWithAuth, getCurrentUser } from './utils/api-client.js';

        async function init() {
            const user = await setupNavbar();
            if (user) {
                loadOrders();
                loadNotifications();
            }
        }

        async function setupNavbar() {
            try {
                const user = await getCurrentUser();
                if (!user) {
                    window.location.href = '/';
                    return null;
                }

                document.getElementById('who').textContent = user.display_name || user.username;

                if (user.role !== 'admin' && user.role !== 'moderator') {
                    window.location.href = '/dashboard.html';
                    return null;
                }

                if (user.role === 'admin' || user.role === 'moderator') {
                    const modLink = document.getElementById('moderatorLink');
                    if (modLink) modLink.style.display = 'block';

                    const ordersLink = document.getElementById('ordersLink');
                    if (ordersLink) ordersLink.style.display = 'block';
                }

                if (user.role === 'admin') {
                    const adminLink = document.getElementById('adminLink');
                    if (adminLink) adminLink.style.display = 'block';

                    const galleryManageLink = document.getElementById('galleryManageLink');
                    if (galleryManageLink) galleryManageLink.style.display = 'block';
                }
                return user;

            } catch (error) {
                console.error("Auth check failed", error);
                window.location.href = '/';
                return null;
            }
        }

        // --- POWIADOMIENIA ---
        async function loadNotifications() {
            const btn = document.getElementById('notificationsBtn');
            const badge = document.getElementById('notificationBadge');
            const dropdown = document.getElementById('notificationsDropdown');
            const list = document.getElementById('notificationsList');

            if (!btn) return;

            try {
                const notifications = await fetchWithAuth('/api/user/notifications');
                const unreadCount = notifications.filter(n => n.is_read === 0).length;

                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
                btn.style.display = 'block';

                if (notifications.length === 0) {
                    list.innerHTML = '<div class="notification-empty">Brak powiadomie≈Ñ.</div>';
                } else {
                    list.innerHTML = notifications.map(n => `
                        <div class="notification-item ${n.is_read === 0 ? 'unread' : ''}" 
                             onclick="window.handleNotificationClick(${n.id}, '${n.link || '#'}', ${n.is_read})"
                        >
                            <div class="notification-title">${n.title}</div>
                            <div class="notification-message">${n.message}</div>
                        </div>
                    `).join('');
                }

                btn.onclick = (e) => {
                    e.stopPropagation();
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                document.addEventListener('click', (e) => {
                    if (dropdown.style.display === 'block' && !dropdown.contains(e.target) && !btn.contains(e.target)) {
                        dropdown.style.display = 'none';
                    }
                });
                const markReadBtn = document.getElementById('markAllReadBtn');
                if (markReadBtn) {
                    markReadBtn.onclick = async () => {
                        await fetchWithAuth('/api/user/notifications/read-all', { method: 'POST' });
                        loadNotifications();
                    };
                }
            } catch (e) {
                console.error('B≈ÇƒÖd powiadomie≈Ñ:', e);
                badge.style.display = 'none';
            }
        }

        window.handleNotificationClick = async (id, link, isRead) => {
            if (isRead === 0) await fetchWithAuth(`/api/user/notifications/${id}/read`, { method: 'POST' });
            if (link && link !== '#') window.location.href = link;
            else loadNotifications();
        };

        // --- ZARZƒÑDZANIE ZAM√ìWIENIAMI (GRUPOWANIE) ---
        async function loadOrders() {
            try {
                const purchases = await fetchWithAuth('/api/admin/orders');
                const list = document.getElementById('ordersList');

                if (!purchases || purchases.length === 0) {
                    list.innerHTML = '<div class="empty-state">Brak zam√≥wie≈Ñ.</div>';
                    return;
                }

                const groupedOrders = {};

                purchases.forEach(item => {
                    const groupKey = `${item.purchase_date}_${item.user_id}`;

                    if (!groupedOrders[groupKey]) {
                        groupedOrders[groupKey] = {
                            ids: [],
                            username: item.username,
                            email: item.email,
                            address: item.address,
                            city: item.city,
                            postal_code: item.postal_code,
                            date: item.purchase_date,
                            status: item.status,
                            items: [],
                            totalPrice: 0
                        };
                    }
                    groupedOrders[groupKey].ids.push(item.id);
                    groupedOrders[groupKey].items.push({
                        name: item.player_name,
                        team: item.team,
                        price: item.jersey_price
                    });
                    groupedOrders[groupKey].totalPrice += item.jersey_price;
                });

                const sortedOrders = Object.values(groupedOrders).sort((a, b) => new Date(b.date) - new Date(a.date));

                list.innerHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th style="width: 50px;">Data</th>
                <th>U≈ºytkownik</th>
                <th>Adres dostawy</th>
                <th>Produkty (Lista)</th>
                <th>Suma</th>
                <th>Status</th>
                <th>Akcja</th>
              </tr>
            </thead>
            <tbody>
              ${sortedOrders.map((order, index) => `
                <tr>
                  <td>
                    <div style="font-size:12px; color:#aaa; white-space:nowrap;">
                        ${new Date(order.date).toLocaleDateString()}
                        <br>
                        ${new Date(order.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                    </div>
                  </td>

                  <td>
                    <strong>${order.username}</strong>
                    <br><small>${order.email || ''}</small>
                  </td>

                  <td>
                    <small style="color: #ccc; font-style: italic;">
                        ${order.address ?
                        `${order.address}<br>${order.postal_code} ${order.city}`
                        : '<span style="opacity:0.5">Brak adresu</span>'}
                    </small>
                  </td>

                  <td>
                    <ul class="order-items-list">
                        ${order.items.map(item => `
                            <li>‚Ä¢ ${item.name} (${item.team}) - <b>${item.price} z≈Ç</b></li>
                        `).join('')}
                    </ul>
                  </td>

                  <td style="font-weight:bold; color:var(--primary-color);">
                    ${order.totalPrice} z≈Ç
                  </td>

                  <td>
                    <span class="status-badge ${order.status === 'completed' ? 'status-completed' : 'status-pending'}">
                        ${order.status}
                    </span>
                  </td>

                  <td>
                    <select onchange="window.updateGroupStatus('${order.ids.join(',')}', this.value)" 
                            class="form-select" 
                            style="padding:5px; font-size:12px; width:120px;">
                        <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>OczekujƒÖce</option>
                        <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Op≈Çacone</option>
                        <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Wys≈Çane</option>
                        <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Anulowane</option>
                    </select>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
            } catch (e) {
                console.error(e);
                document.getElementById('ordersList').innerHTML = 'Brak uprawnie≈Ñ lub b≈ÇƒÖd po≈ÇƒÖczenia.';
            }
        }

        window.updateGroupStatus = async (idsString, status) => {
            if (!confirm(`Zmieniƒá status ca≈Çego zam√≥wienia na: ${status}?`)) {
                loadOrders();
                return;
            }

            const ids = idsString.split(',');
            let successCount = 0;

            try {
                const updates = ids.map(id =>
                    fetchWithAuth(`/api/admin/orders/${id}/status`, {
                        method: 'PUT',
                        body: JSON.stringify({ status })
                    }).then(() => successCount++)
                );

                await Promise.all(updates);

                loadOrders();
            } catch (e) {
                alert("B≈ÇƒÖd aktualizacji: " + e.message);
                loadOrders();
            }
        };

        document.getElementById('logoutBtn').onclick = async () => {
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = '/';
        };


        init();

        const logoSection = document.querySelector('.logo-section');
        if (logoSection) {
            logoSection.addEventListener('click', () => {
                window.location.href = '/dashboard.html';
            });
        }
    </script>

    <script type="module" src="/theme-manager.js"></script>
</body>

</html>