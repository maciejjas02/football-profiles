<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <title>Zarzdzanie Zam贸wieniami</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        .dashboard-container {
            max-width: 1400px;
            margin: 100px auto 0;
            padding: 0 20px 40px;
            width: 100%;
            display: block;
        }
    </style>
</head>

<body>
    <header class="topbar">
        <div class="topbar-content">
            <div class="logo-section">
                <img src="/images/logo.png" class="topbar-logo" />
                <span class="site-title">Football Profiles</span>
            </div>
            <nav class="topbar-nav">
                <a href="dashboard.html" class="nav-tab">Panel</a>
                <a href="gallery.html" class="nav-tab">Galeria</a>
                <a href="forum.html" class="nav-tab">Forum</a>

                <a href="moderator-posts.html" class="nav-tab" id="moderatorLink" style="display:none;">Moderacja</a>
                <a href="admin-categories.html" class="nav-tab" id="adminLink" style="display:none;">Admin</a>
                <a href="admin-gallery-manage.html" class="nav-tab" id="galleryManageLink"
                    style="display:none;">Zarzdzaj Galeriami</a>
                <a href="admin-orders.html" class="nav-tab active" id="ordersLink" style="display:none;">Zam贸wienia</a>
            </nav>
            <div class="topbar-actions">
                <div style="position:relative;">
                    <button id="notificationsBtn" class="icon-button" aria-label="Powiadomienia" style="display:none;">
                        <span></span>
                        <span id="notificationBadge" class="notification-badge" style="display:none;">0</span>
                    </button>
                    <div id="notificationsDropdown" class="notification-dropdown" style="display:none;">
                        <div class="notification-header">
                            <h3>Powiadomienia</h3>
                            <button id="markAllReadBtn" class="btn-link">Oznacz wszystkie jako przeczytane</button>
                        </div>
                        <div class="notification-list" id="notificationsList">
                            <div class="notification-empty">Brak powiadomie.</div>
                        </div>
                    </div>
                </div>

                <div id="authBar" class="authbar">
                    <span id="who">...</span>
                    <button id="logoutBtn" class="btn btn-ghost">Wyloguj</button>
                </div>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <div class="page-header">
            <h1 class="page-title"> Zarzdzanie Zam贸wieniami</h1>
        </div>

        <div class="admin-panel">
            <div id="ordersList">adowanie...</div>
        </div>
    </div>

    <script type="module">
        import { fetchWithAuth, getCurrentUser } from './utils/api-client.js';

        async function init() {
            const user = await setupNavbar();
            if (user) {
                loadOrders();
                loadNotifications(); // Zaaduj powiadomienia
            }
        }

        async function setupNavbar() {
            try {
                const user = await getCurrentUser();
                if (!user) {
                    window.location.href = '/';
                    return null;
                }

                document.getElementById('who').textContent = user.display_name || user.username;

                if (user.role !== 'admin' && user.role !== 'moderator') {
                    window.location.href = '/dashboard.html';
                    return null;
                }

                if (user.role === 'admin' || user.role === 'moderator') {
                    const modLink = document.getElementById('moderatorLink');
                    if (modLink) modLink.style.display = 'block';

                    const ordersLink = document.getElementById('ordersLink');
                    if (ordersLink) ordersLink.style.display = 'block';
                }

                if (user.role === 'admin') {
                    const adminLink = document.getElementById('adminLink');
                    if (adminLink) adminLink.style.display = 'block';

                    const galleryManageLink = document.getElementById('galleryManageLink');
                    if (galleryManageLink) galleryManageLink.style.display = 'block';
                }
                return user;

            } catch (error) {
                console.error("Auth check failed", error);
                window.location.href = '/';
                return null;
            }
        }

        // --- LOGIKA POWIADOMIE ---
        async function loadNotifications() {
            const btn = document.getElementById('notificationsBtn');
            const badge = document.getElementById('notificationBadge');
            const dropdown = document.getElementById('notificationsDropdown');
            const list = document.getElementById('notificationsList');

            if (!btn) return;

            try {
                // U偶ywamy fetchWithAuth, kt贸ry zwraca JSON
                const notifications = await fetchWithAuth('/api/user/notifications');

                const unreadCount = notifications.filter(n => n.is_read === 0).length;

                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }

                btn.style.display = 'block'; // Poka偶 dzwonek

                if (notifications.length === 0) {
                    list.innerHTML = '<div class="notification-empty">Brak powiadomie.</div>';
                } else {
                    list.innerHTML = notifications.map(n => `
                        <div class="notification-item ${n.is_read === 0 ? 'unread' : ''}" 
                             onclick="window.handleNotificationClick(${n.id}, '${n.link || '#'}', ${n.is_read})"
                        >
                            <div class="notification-title">${n.title}</div>
                            <div class="notification-message">${n.message}</div>
                            <div class="notification-time">${new Date(n.created_at).toLocaleDateString()}</div>
                        </div>
                    `).join('');
                }

                // Obsuga kliknicia w dzwonek
                btn.onclick = (e) => {
                    e.stopPropagation();
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };

                // Kliknicie poza dropdownem zamyka go
                document.addEventListener('click', (e) => {
                    if (dropdown.style.display === 'block' && !dropdown.contains(e.target) && !btn.contains(e.target)) {
                        dropdown.style.display = 'none';
                    }
                });

                // Przycisk "Oznacz wszystkie jako przeczytane"
                const markReadBtn = document.getElementById('markAllReadBtn');
                if (markReadBtn) {
                    markReadBtn.onclick = async () => {
                        await fetchWithAuth('/api/user/notifications/read-all', { method: 'POST' });
                        loadNotifications();
                    };
                }

            } catch (e) {
                console.error('Bd powiadomie:', e);
                badge.style.display = 'none';
            }
        }

        // Funkcja globalna do obsugi kliknicia w powiadomienie
        window.handleNotificationClick = async (id, link, isRead) => {
            if (isRead === 0) {
                await fetchWithAuth(`/api/user/notifications/${id}/read`, { method: 'POST' });
            }
            if (link && link !== '#') {
                window.location.href = link;
            } else {
                loadNotifications();
            }
        };
        // --- KONIEC LOGIKI POWIADOMIE ---

        async function loadOrders() {
            try {
                const orders = await fetchWithAuth('/api/admin/orders');
                const list = document.getElementById('ordersList');

                if (!orders || orders.length === 0) {
                    list.innerHTML = '<div class="empty-state">Brak zam贸wie.</div>';
                    return;
                }

                list.innerHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>U偶ytkownik</th>
                <th>Produkt</th>
                <th>Cena</th>
                <th>Data</th>
                <th>Status</th>
                <th>Akcja</th>
              </tr>
            </thead>
            <tbody>
              ${orders.map(o => `
                <tr>
                  <td>#${o.id}</td>
                  <td>${o.username}<br><small>${o.email || ''}</small></td>
                  <td>${o.player_name} (${o.team})</td>
                  <td>${o.jersey_price} z</td>
                  <td>${new Date(o.purchase_date).toLocaleDateString()}</td>
                  <td>
                    <span class="status-badge ${o.status === 'completed' ? 'status-completed' : 'status-pending'}">
                        ${o.status}
                    </span>
                  </td>
                  <td>
                    <select onchange="window.updateStatus(${o.id}, this.value)" class="form-select" style="padding:5px; font-size:12px;">
                        <option value="pending" ${o.status === 'pending' ? 'selected' : ''}>Oczekujce</option>
                        <option value="completed" ${o.status === 'completed' ? 'selected' : ''}>Opacone</option>
                        <option value="shipped" ${o.status === 'shipped' ? 'selected' : ''}>Wysane</option>
                        <option value="cancelled" ${o.status === 'cancelled' ? 'selected' : ''}>Anulowane</option>
                    </select>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
            } catch (e) {
                console.error(e);
                document.getElementById('ordersList').innerHTML = 'Brak uprawnie lub bd poczenia.';
            }
        }

        window.updateStatus = async (id, status) => {
            if (!confirm(`Zmieni status na ${status}?`)) return;
            try {
                await fetchWithAuth(`/api/admin/orders/${id}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status })
                });
                loadOrders(); // Odwie偶 list
            } catch (e) {
                alert("Bd aktualizacji statusu");
            }
        };

        document.getElementById('logoutBtn').onclick = async () => {
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = '/';
        };

        init();
    </script>
</body>

</html>